# 第9章 存储系统

## 9.1 概述

### 9.1.1 存储系统的层次结构

典型结构：高速缓存（Cache）- 主存 - 外存

<img src="image/image-20241225155432154.png" alt="image-20241225155432154" style="zoom:50%;" />

| 类型  | 容量 | 速度 |
| ----- | ---- | ---- |
| Cache | 小   | 高   |
| 主存  | 较大 | 较高 |
| 外存  | 大   | 慢   |

CPU工作流程：

<img src="image/image-20241225155454292.png" alt="image-20241225155454292" style="zoom:50%;" />

### 9.1.2 存储器分类

#### 1. 按存储介质

| 分类                       | 存储方式                                               | 特点                                                       | 应用场合             |
| -------------------------- | ------------------------------------------------------ | ---------------------------------------------------------- | -------------------- |
| 静态存储器（半导体存储器） | 用双稳态触发器存储信息                                 | 速度快、有源器件、非破坏性读出、集成度低、功耗大、信息易失 | 高速缓存、小容量主存 |
| 动态存储器（半导体存储器） | 用电容存储的电荷存储信息                               | 速度低、需要刷新、集成度高、功耗小                         | 大容量主存           |
| 磁表面存储器               | 磁层上不同方向的磁化区域表示信息                       | 速度慢、容量大、非破坏性读出、长期保存信息                 | 外部存储器           |
| 光盘存储器（只读光盘）     | 用激光对光盘表面的记录膜进行照射后是否出现融坑表示信息 | 速度慢、容量大、非破坏性读出、长期保存信息                 | 外部存储器           |

#### 2. 存取方式分类

1. 随机访问存储器（RAM）

   随机存取：按地址访问存储器中的任一单元，访问时间与地址单元位置无关

   - RWM可执行操作：读/写，SRAM、DRAM

   - ROM存储器：只读不写
     - 固存：用户不能编程
     - PROM：用户可一次编程
     - EPROM：用户可多次编程（紫外线擦除）
     - EEPROM：用户可多次编程（电擦除）

   eg. 主存、高速缓存 Cache

2. 顺序访问存储器（SAM）

   读/写部件按顺序查找目标地址，访问时间与数据位置有关

   eg. 磁带（外部辅助存储）

3. 直接访问存储器（DAM）

   读/写部件先直接指向一个小区域，再在该区域内顺序查找，访问时间与数据位置有关

   eg. 磁盘、光盘（外存）

#### 3. 存储器的技术指标

1. 存取时间($T_A$) ：从存储器收到读写命令到读出（写入）信息所需时间

2. 存取周期($T_M$)：存储器做连续访问操作过程中一次完整的存取操作所需的全部时间

   <img src="image/image-20241225172349630.png" alt="image-20241225172349630" style="zoom:50%;" />

3. 数据传输率($R$)：单位时间内存取的信息数量（带宽）
   $$
   数据传输率=\frac{存储器数据位宽}{存取周期}bps
   $$



## 9.2 半导体存储器

RWM（可读可写）：

- 双极性存储单元
- 静态MOS存储单元——SRAM
- 动态MOS存储单元——DRAM

### 9.2.1 静态MOS存储单元与存储芯片

#### 1.  六管静态单元

静态易失存储单元：电源正常，维持存储信息不变；掉电后，信息不存在

静态单元是非破坏读出，读出后不需重写

一个位单元：存放1位二进制信息的存储电路

#### 2. 存储芯片举例

<img src="image/image-20241225174125408.png" alt="image-20241225174125408" style="zoom:50%;" />

- 地址引脚：$A_9\sim A_0$
- 数据引脚：$D_3 \sim D_0$
- 电源、地
- 控制端：
  - 片选$\overline{CS}$
    - 0：选中芯片
    - 1：未选中芯片
  - 写使能$\overline{WE}$
    - 0：写
    - 1：读



**一维地址译码方式：**

<img src="image/image-20241225174950662.png" alt="image-20241225174950662" style="zoom:50%;" />

存储阵列的每一行对应一个字，共用一根字线

缺点：地址线增加时，译码器的复杂度以$2^n$增加



**二维地址译码的位选方式：**

<img src="image/image-20241225175353269.png" alt="image-20241225175353269" style="zoom:50%;" />

优点：译码线少

缺点：需要多片构成字



**内部寻址逻辑：**

<img src="image/image-20241225180152633.png" alt="image-20241225180152633" style="zoom:50%;" />

<img src="image/image-20241225180445903.png" alt="image-20241225180445903" style="zoom:50%;" />

寻址空间1K，共1K×4个位单元，分成4个位平面，每个平面1K×1位

### 9.2.2 动态MOS存储单元与存储芯片

#### 1. 四管单元

动态：保持原状态需定期向电容补充电荷（动态刷新）

四管单元是非破坏性读出，读出过程实现刷新

#### 2. 单管单元

单管单元是破坏性读出，读出后需重写

### 9.2.3 动态存储器的刷新

刷新原因：动态存储器依靠电容电荷存储信息。电容电荷随时间推移将缓慢释放（泄露），需要定期对原存储信息为1的电容补充电荷

- 刷新：动态存储器，需定期补充电荷以保持原来信息
- 重写：破坏性读出后重写，以恢复原来的信息

大多数DRAM要求：2-64ms内对所有单元刷新一遍

刷新方法：各动态芯片可同时刷新，片内按行刷新（按行读）

（注：单管动态存储器，读出时能自动重写补充电荷）

基本概念：

- 刷新周期（存取周期）：刷新一行所用的时间
- 刷新周期数：刷新一片芯片所需的周期数由芯片矩阵的行数决定
- 对主存访问：
  - CPU访存：由CPU提供行、列地址随机访问
  - 芯片刷新：由刷新地址计数器提供地址定时刷新

刷新周期的安排方式：

- 集中刷新：规定时间内集中安排所有刷新周期

  用于实时要求不高的场合，在死区的期间不能使用存储器

  <img src="image/image-20241225202451756.png" alt="image-20241225202451756" style="zoom:50%;" />

- 分散刷新：各刷新周期分散安排在存取周期中

  造成主存利用率降低，用在低速系统中

  <img src="image/image-20241225202650650.png" alt="image-20241225202650650" style="zoom:50%;" />

- 异步刷新：刷新周期分散安排在规定周期内

  <img src="image/image-20241225202909180.png" alt="image-20241225202909180" style="zoom:50%;" />



# 第10章 输入输出系统

## 10.1 总线

总线：一组为多个部件分时共享信息的传送路线

特点：分时共享（特定时刻只允许一个部件送出数据到总线上）

分类：

1. 按传输信号的类型

   - 数据总线：传输数据信息，决定总线宽度
   - 地址总线：传输地址信息，决定寻址能力
   - 控制总线：传输控制信息和状态信息

2. 按数据传送格式划分

   - 并行总线：多条数据线，并行传送各位信息
   - 串行总线：一条数据线，分时逐位传送各位消息

3. 按时序控制方式划分

   - 同步总线：由统一时序信号控制总线传送操作在固定时钟周期内（一个、多个）完成数据传输，由同步脉冲定时打入

     <img src="image/image-20241225204353385.png" alt="image-20241225204353385" style="zoom:50%;" />

   - 异步总线：无固定时钟周期划分，以异步应答方式控制传送

     <img src="image/image-20241225204616003.png" alt="image-20241225204616003" style="zoom:50%;" />

   - 扩展同步总线：以时钟周期为基础，允许总线周期中的时钟周期数可变（既有统一时序同步时钟，又有应答信号）

     总线周期：完成一次主存或IO端口访问的时间

     <img src="image/image-20241225204952394.png" alt="image-20241225204952394" style="zoom:50%;" />

4. 按功能划分

   - 内总线
   - 局部总线
   - 系统总线
   - 外总线

   <img src="image/image-20241225205246890.png" alt="image-20241225205246890" style="zoom: 40%;" />

5. 按方向划分

   - 单向总线
   - 双向总线

总线标准：针对系统总线和外总线，对总线所作统一的规范

物理特征、功能特征、电气特征、时间特征

总线仲裁：多个部件同时提出总线控制请求时，采用优先级或公平策略进行仲裁

根据总裁电路的位置不同，分为：

- 分布式仲裁

  <img src="image/image-20241225211516290.png" alt="image-20241225211516290" style="zoom:50%;" />

  设备需控制总线时，发请求信号，并监听其他请求信号，各设备能判别自己的优先级，以及能否在下一周期控制总线

  缺点：信号线复杂

  优点：防止总线时间浪费

- 集中式仲裁

  1. 链式查询方式

     <img src="image/image-20241225210141270.png" alt="image-20241225210141270" style="zoom:50%;" />

     总线授权信号依次串行地传送到所连接的外围设备上进行比较

     离总线控制器的逻辑距离决定，越近优先级越高

  2. 计数器定时查询方式

     <img src="image/image-20241225210744146.png" alt="image-20241225210744146" style="zoom:50%;" />

     查询计数器数值与发出请求的设备编号一致时，中止查询，该设备或总线控制权

     优先级灵活：计数器初值、设备编号可通过程序设定，优先次序可用程序控制

  3. 独立请求方式

     <img src="image/image-20241225211026948.png" alt="image-20241225211026948" style="zoom:50%;" />

     各设备均通过专用请求信号线与仲裁器连接，且通过独立的授权信号线接收总线批准信号

## 10.2 接口

输入输出设备↔外部设备↔外设

输入输出接口（I/O接口）：外设与系统总线之间的逻辑电路

I/O接口作用：

- 工作速度

  不同速度外设与CPU连接

- 数据格式转换

  外设与CPU的数据格式可能不同

- 一次数据传送量的控制

- 其他因素（电平转换……）

接口模型：

<img src="image/image-20241225212401394.png" alt="image-20241225212401394" style="zoom:50%;" />

### I/O接口主要功能

1. 寻址

   接收CPU送来的地址码，选择接口中的寄存器提供CPU访问

2. 数据缓冲

   主机与外设的速度匹配

   缓冲深度与传送的数据量有关

3. 预处理

   串-并格式转换（串口）

   数据通路宽度转换（并口）

   电平转换

4. 控制功能

   传送控制命令与状态信息，实现I/O传送

### 接口编址

- 统一编址：为每个端口分配总线地址通用的传送类指令
- 单独编址：编址到设备端口，有专门的I/O指令

### 接口分类

1. 按数据传送格式划分

   - 并行接口：接口与系统总线、接口与外设均按并行方式传送数据，数据各位同时传送

     适合：设备本身并行工作、距主机较近的场合

   - 串行接口：接口与系统总线并行传送，接口与外设串行传送，数据逐位分时传送

     <img src="image/image-20241225213554417.png" alt="image-20241225213554417" style="zoom:50%;" />

2. 按时序控制方式划分

   - 同步接口：连接同步总线，接口与系统总线的信息传送由统一时序信号控制
   - 异步接口：连接异步总线，接口与系统总线的信息传送采用异步应答方式

3. 按主机与外设的信息交换方式

   - 直接程序传送：依靠CPU直接执行相关的I/O程序来实现数据的输入、输出控制
   - 中断方式：设备提出终端请求，主机响应后与设备交换信息，接口中包含中断控制逻辑
   - DMA方式：支持高速外设与主存之间进行DMA方式交换数据

## 10.3 程序直接传送及接口

执行I/O指令之前，先查询设备状态，等待外设准备好或完成一次操作，CPU再执行指令与外设交换信息

执行I/O操作时，CPU直接访问I/O接口，输入或输出数据

1. 设备状态

   <img src="image/image-20241225214756083.png" alt="image-20241225214756083" style="zoom:50%;" />

2. 查询方式的程序流程

   1. 输出指令设置启动信号
   2. 输入指令读取状态信息并判断
   3. I/O指令读/写数据

3. 优缺点

   - 优：硬件开销小
   - 缺：并行程度低

4. 应用场合

   - 对CPU效率要求不高的场合
   - 诊断、调试过程

## 10.4 程序中断方式与接口



## 10.5 DMA方式与接口

中断方式消除程序查询方式CPU空闲等待现象，在没有中断处理任务时，CPU和外设可以并行工作。但在中断响应和执行中断服务程序时，仍需依靠CPU。为解决高速设备与主存间的大数据量传输问题，采用DMA方式

### 10.5.1 基本概念

1. DMA定义：直接依靠硬件系统来控制主存与设备之间的数据传送，传送期间无需CPU干预，传送结束后通常用中断方式通知CPU

<img src="image/image-20241225220421385.png" alt="image-20241225220421385" style="zoom:50%;" />

2. 特点：

   - 响应随机请求
   - 不影响CPU程序的执行，仅占用总线、无程序切换
   - 大批量数据简单传送

3. 典型应用

   