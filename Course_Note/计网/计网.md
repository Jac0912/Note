
| EN   | CH                          |
| ---- | --------------------------- |
| SR   | 选择性重传                       |
| CIDR | 无分类域间路由                     |
| DHCP | 动态主机配置协议                    |
| NAT  | 网络地址转换                      |
| ICMP | 因特网控制报文协议                   |
| MTU  | 最大传输单元（数据链路层一次能传输的最大字节数）    |
| MSS  | 最大报文段长度（TCP 报文段中可装载的最大有效载荷） |
| AIMD | 加性增、乘性减                     |
| ECN  | 明确拥塞通告                      |
| CDN  | 内容分发网络                      |

# 1. 计网和因特网
计算机网络：两台以上具有独立操作系统的计算机通过某些介质连接成的相互共享软硬件资源的集合体。
Internet 构成描述：
- 数以亿计的计算互联设备
	- 主机 = 端系统
	- 运行网络应用程序
- 通信链路
	- 双绞线，光纤，无线电频谱，卫星
	- 传输速率 = 带宽
- 分组交换
	- 路由器、交换机

Internet 服务描述：
- 提供网络应用基础架构
	- 允许终端系统上运行分布式应用程序，并彼此交换数据
- 为分布式应用程序提供的通信服务接口
	- 无连接服务
	- 面向连接服务
	- 不提供数据传递时间保证的服务

协议：定义了两个或多个通信实体间所交换报文的格式和次序，以及在报文发送和/或接收者其他事件方面所采取的行动（响应）

协议基本要素：语法、语义、同步

网络结构：
- 网络边缘：
	- 主机：客户机和服务器
	- 服务器一般位于数据中心内
- 接入网络，物理介质：
	- 有线通信链路
	- 无线通信链路
- 网络核心：
	- 互联的路由器
	- 网络组成的网络

端系统、客户、服务器：
- 端系统（主机）
	- 运行网络应用程序
	- 处在网络的边缘
	- 传统主机/网络计算机和瘦客户
- 客户/服务器（C/S 模型）
	- 客户请求，并接受服务器提供服务
- 端对端模型
	- 极少或不采用专门服务器

接入网络：
- 家庭接入网络
- 企业接入网络（LAN）
- WIFI 无限接入网络
- 广域无线接入网络

物理介质：
- 物理链路：发送方和接收方间，传播位信号
- 导引型媒体：信号在固态介质中有向传播
	- 双绞线：屏蔽双绞线、非屏蔽双绞线
	- 同轴电缆：两根彼此绝缘的同心导体
	- 光纤：每个光脉冲代表 1 位
- 非导引型媒体：信号在大气空间或外太空空间自由传播，如无线电

端系统上的因特网服务：
- 面向连接的服务：TCP（HTTP、FTP、Telnet、SMTP）
- 无连接服务：UDP（流媒体、视频会议、DNS、Internet 电话）

网络核心部分：
![|375](image/Pasted%20image%2020250614175452.png)
- 电路交换：频分、时分，网络资源被分片，多路复用
- 分组交换：每个端到端的数据流被划分成分组 - 统计复用
	- 所有分组共享网络资源
	- 每个分组使用全部链路带宽
	- 资源按需使用
	- 资源竞争
		- 资源需求总量可以大于可获得资源的总量
		- 拥塞：采用分组队列，等待使用链路
		- 存储转发：分组每次转发 1 站
			- 在 1 个链路上传输
			- 每经过 1 个链路转发 1 次
			- 转发分组前，要求收到完整分组

分组交换分类：
- 数据报网络（面向连接/无连接）：
	- 分组目的地址决定下一跳
	- 会话期间路由可以改变
- 虚电路网络（面向连接）：
	- 每个分组有 1 个标签（虚电路号），标签决定下一跳
	- 连接建立时确定固定的路径，并且将保持于整个会话期间
	- 路由器必须为每个连接维护状态信息

分组丢失、延迟产生原因：
- 路由器分组缓冲区队列
- 分组到达输出链路的速率超过输出链路的容量，产生延迟，甚至丢失
- 分组在缓冲区队列排队，按序等待

分组延迟分类：
1. 节点处理时延：
	- 检查错误位
	- 选择输出链路
	- 高速路由器处理延迟 - 微秒级
2. 排队延迟：
	流量强度 = La / R （a：平均分组到达率）
	![|239](image/Pasted%20image%2020250605075538.png)
	- 等待被发送到输出链路上的时间
	- 取决于路由器的拥塞程度
3. 传输时延：
	发送分组比特流的时间 = L / R
	- R：链路带宽（bps）
	- L：分组长度（bits）
4. 传播时延：
	传播延迟 = d / s
	- d：物理链路的长度
	- s：介质的信号传播速度（$2\times 10^8m/sec$）

分组丢失：
- 路由器输入链路和输出链路的缓冲区容量有限
- 当分组到达路由器输入链路发现缓冲区已满，则路由器只好丢弃分组
- 当分组在路由器内部要转发到输出链路时发现输出缓冲区队列已满，路由器只好丢弃分组
- 丢失的分组可能被前路由节点、源节点重传，或不重传
- 丢包率或分组丢失率

吞吐量：单位时间内整个网络传输数据的速率或分组数（bps）
瞬时吞吐量：某一瞬间的吞吐量
平均吞吐量：一段时间内的吞吐量均值

Internet 分层好处：
- 处理复杂的系统
- 清楚的结构允许对大型复杂系统定义其特定部分，探讨各部分关系
- 模块化使得系统的维护、升级简化
- 改变某一层服务的具体实现对系统其余部分透明
Internet 分层坏处：
- 各层可能重复较低层功能

国际协议栈：
1. 应用层（报文）：支持网络应用、报文传送（FTP、SMTP）
2. 传输层（报文段）：主机进程间数据段传送（TCP、UDP）
3. 网络层（数据报）：主机（源目标节点）间分组传送（IP 协议、路由协议）
4. 链路层（帧）：相邻网络节点间的数据帧传送
5. 物理层（比特）：物理介质上的比特传送

分成逻辑通信：
- 分布式
- 节点网络实体实现各层功能
	- 主机：实现 5 层功能
	- 路由器、交换机：实现 2~3 层功能
- 网络**实体**完成功能动作，**对等实体**交换消息
	- 实体：定义自身功能的硬/软件集合
	- 对等实体（对等程序、对等进程）：两台计算机上同一层所属的程序、进程或实体

协议分层与数据：
- 各层发送方从上层到下层，接收方从下层到上层传递数据
- 发送方添加头部信息创建新的数据单元，接收方去掉头部
- 传递新的数据单元到下层/上层
- 各层传送不同的协议数据单元

网络攻击方式：
- 植入恶意软件
- 攻击服务器和网络基础设施
- 嗅探分组
- 伪装
- 修改或删除报文

# 2. 应用层
应用层作用：
- 研发网络应用程序的核心
	- 写出能够运行在不同的端系统并通过网络彼此通信的程序
- 没有应用程序软件运行在网络核心设备上
	- 网络核心设备不在应用层起作用
	- 促进了应用程序的研发

C/S 体系结构：
优点：服务器地址已知，定位快速。
缺点：服务器向客户机提供服务的能力有限，随着客户机的增加，网络服务能力下降，并且服务器故障将会导致服务丢失。

进程通信：
- 进程：运行在端系统中的程序
- 同一主机上的两个进程通过内部进程通信机制通信
- 不同主机上的进程通过交换报文相互通信

进程与网络的接口：套接字

应用层协议：
1. 分类
	- 公共领域协议（HTTP、SMTP）
	- 专用协议
2. 作用
	- 交换报文类型，如请求/应答报文
	- 报文类型的语法：报文中的各个字段及其详细描述
	- 字段的语义，即包含在字段中的信息含义
	- 进程何时、如何发送报文，及时对报文进行响应

传输层协议提供的服务：
1. TCP 服务
	- 面向连接的服务：在客户机程序和服务器程序之间必须建立连接
	- 可靠的传输服务： 接收和发送进程间
	- 流量控制: 发送方不会淹没接收方
	- 拥塞控制: 网络出现拥塞时抑制发送进程
	- 没有提供：时延保证，最小带宽保证
2. UDP 服务
	- 不可靠数据传输
	- 没有提供：建立连接，可靠性，流量控制，拥塞控制，时延和带宽保证

安全 TCP：SSL

HTTP：
- 网页：由许多对象组成
- 对象：文件（HTML、JPEG ……）
- 每个对象被一个 URL 寻址
	![|325](image/Pasted%20image%2020250531210907.png)
- 使用 TCP：
	- 客户初始化与 HTTP 服务器 80 端口的 TCP 连接（创建套接字）
	- HTTP 服务器接收来自客户的 TCP 请求，建立连接
	- Browser 和 Web 服务器交换 HTTP 消息（应用协议消息），包括 HTTP 请求和响应信息
	- 结束 TCP 连接
- HTTP 为无状态协议

HTTP 连接分类：
1. 非持久 HTTP 连接
	- 每个 TCP 连接只传送一个对象
	- HTTP/1.0 使用非持久连接
	- 问题：
		- 每个对象需要 2 个 RTT
		- OS 必须为每个 TCP 连接分配主机资源
		- 大量客户的并发 TCP 连接形成服务器的严重负担
2. 持久 HTTP 连接
	- 服务器发送响应消息后保持连接同 1 客户/服务器的后续 HTTP 消息继续在该连接上传送
	- 分类：
		1. 不带流水线的持久 HTTP 连接
			- 客户先前响应消息收到，才发出新的请求消息
			- 每个引用对象经历 1 个 RTT
		2. 带流水线的持久 HTTP 连接
			- 客户遇到 1 个引用对象就发送请求消息
			- 所有引用对象只经历 1 个 RTT
			- HTTP/1.1 默认使用持久连接

响应时间模型：
- 往返时间 RTT：1 个小分组从客户主机到服务器再到客户主机所花费的时间
- 响应时间：
	- 1 个 RTT 用于建立 TCP 连接
	- 1 个 RTT 用于 HTTP 请求/响应消息的交互
	- html 文件传输时间
- total = 2RTT + transmit time

HTTP1.1 请求的延迟：
- HTTP1.1：在单个 TCP 连接上引入了多个流水线 GET
- 服务器按顺序响应 GET 请求（FCFS: first-come-first-served scheduling）
- 对于 FCFS，小对象可能必须在大对象后面等待传输（ head-of-line (HOL) blocking, 线头阻塞 HOL）
- 丢失恢复（重新传输丢失的 TCP 段）对对象传输时间的影响
- ![|475](image/Pasted%20image%2020250601102628.png)

HTTP/2：
- 关键目标：减少多对象 HTTP 请求的延迟
- 增加服务器向客户端发送对象的灵活性
- 方法、状态码、大多数头字段与 HTTP1.1 相比没有变化
- 基于客户端指定的对象优先级的请求对象的传输顺序（不一定是 FCFS）
- 将未请求的对象推送到客户端
- 将对象划分为帧，安排帧以减少 HOL 阻塞
- ![|475](image/Pasted%20image%2020250601102718.png)
- 缺点：
	- 从数据包丢失中恢复仍然暂停所有对象传输
	- 与 HTTP1.1 一样，浏览器自动打开多个并行 TCP 连接，以减少停滞，提高整体吞吐量
	- 普通 TCP 连接没有安全性

HTTP/3：通过 UDP 增加了安全性、每个对象的错误和拥塞控制

2 类 HTTP 报文：请求报文、响应报文
HTTP 请求报文：ASCII 文本
```txt
GET /somedir/page.html HTTP/1.1  //请求行（GET/POST/HEAD）

//首部行
Host: www.someschool.edu
User-agent: Mozilla/4.0 //该代理类型的对象版本
Connection: Close  //不使用持久连接
Accept-language:zh-cn //中文版本
//首部行

(额外的回车换行，指示结束)
```
![|425](image/Pasted%20image%2020250601103625.png)
URI：Uniform Resource Identifiers

响应报文：
```txt
HTTP/1.1 200 OK  //状态行(版本、状态编码、短语)

//首部行
Connection：close
Date: Sat, 06 Aug 2011 12:00:15 GMT
Server: Apache/1.3.0 (Unix)
Last-Modified: Thu, 22 Jun 2011 …...
Content-Length: 6821
Content-Type: text/html
//首部行

data data data data data ...  //数据
```

|                                 | HTTP/1.0 | HTTP/1.1 |
| :------------------------------ | :------: | :------: |
| GET                             |    √     |    √     |
| POST                            |    √     |    √     |
| HEAD（服务器收到请求，用 HTTP 报文响应，不返回请求对象） |    √     |    √     |
| PUT（文件在实体主体中被上载到 URL 字段指定的路径）     |          |    √     |
| DELETE（删除 URL 字段指定的文件）            |          |    √     |

上载表单输入值：
- POST 方法：输入值在请求报文的实体主体中上载到服务器
- URL 方法：使用 GET 方法，用 URL 请求行字段
	www.somesite.com/animalsearch?monkeys&banana

HTTP 响应的状态码：
- 位于服务器响应客户的响应消息的第一行

| 状态码 | 信息                                       |
| --- | ---------------------------------------- |
| 200 | 请求成功, 所请求信息在响应消息中返回                      |
| 301 | 所请求的对象已永久迁移, 新的 URL 在本响应消息的（location：）头部指出 |
| 400 | 该请求不能被服务器解读                              |
| 404 | 服务器上不存在所请求文档                             |
| 505 |  HTTP Version Not Supported              |

Cookies：
- cookie 头部行在 HTTP 响应信息中
- cookie 头部行在 HTTP 请求信息中
- cookie 文件保存在用户主机中并被用户浏览器管理
- cookie 也保存在 Web 站点的后端数据库

Web 缓存（代理服务器）
缓存器既是服务器又是客户机
目标：代表起始服务器满足 HTTP 请求
用户配置浏览器：Web 访问经由缓存
所有 HTTP 请求指向缓存：
- 对象在缓存中：缓存器返回对象
- 否则缓存器向起始服务器发出请求，接收对象后转发给客户机

需要 Web 缓存器原因：
1. 减少对客户机请求的响应时间
2. 减少内部网络与接入链路上的通信量
3. 从整体上大大降低因特网上的 Web 流量

条件 GET 方法
目的：证实缓存器的对象是否为最新
缓存器：在请求报文中包含对象最后修改时间（`If-modified-since: <date>`）
服务器：如果对象是最新的则响应报文中不包含对象（`HTTP/1.0 304 Not Modified`）

电子邮件（TCP）：
- 用户代理
	- 允许用户阅读、回复、转发、保存，编辑邮件消息
	- 发送，接收邮件消息到/从服务器
	- 运行邮件协议
- 邮件服务器
	- 邮箱存放用户接收的邮件信息
	- 外出报文队列
	- 运行邮件协议
- 简单邮件传送/接收协议
- SMTP 特点：
	- SMTP 使用持久连接
	- SMTP 要求邮件消息（header & body）必须是 7-bit ASCII
	- SMTP 服务器使用 CRLF.CRLF 来判断邮件消息的结束

与 HTTP 比较：
1. HTTP：拉协议
2. SMTP：推协议
3. 都有 ASCII 命令/应答交互, 状态码
4. HTTP: 每个对象封装在它各自的 HTTP 响应消息中发送
5. SMTP: 一个邮件内各个对象置于同一个邮件消息的多目部分发送

文本邮件消息格式标准:
```txt
信头－头部行。如：
	To:
	From:
	Subject:
这些头部不同于SMTP命令!

信体: 邮件消息也必须是ASCII字符
```
![|250](image/Pasted%20image%2020250601210640.png)

- SMTP: 递送/存储邮件消息到接收者邮件服务器
- 邮件访问协议: 从服务器获取邮件消息
	- POP: Post Office Protocol 邮局协议 110 端口号
		- 身份认证 (代理 <-->服务器) 并 下载邮件消息
		- 换客户端后不能再读邮件
		- “Download-and-keep”模式: 在不同客户机上的邮件拷贝
		- POP3 的会话是无状态的
	- IMAP: Internet Message Access Protocol 143 端口
		- 保存所有邮件消息在服务器
		- 允许用户在服务器的各文件夹中管理邮件消息
		- IMAP 跟踪用户会话的状态信息 : 文件夹和邮件消息 IDs 与文件夹名字的映射
	- HTTP: Hotmail , Yahoo! Mail, etc.

DNS 服务器提供的功能：
1. 主机名到 IP 地址的转换
2. 主机别名：一个主机可以有一个规范主机名和多个主机别名
3. 邮件服务器别名
4. 负载分配
	DNS 实现冗余服务器：一个 IP 地址集合可以对应于同一个规范主机名。

特点：
- 分布式数据库：一个由分层 DNS 服务器实现的分布式数据库
- 应用层协议：DNS 服务器实现域名转换 (域名/地址转换)
![|425](image/Pasted%20image%2020250601211828.png)

为什么不使用集中式 DNS：
1. 单点故障
2. 巨大访问量
3. 远距离集中式数据库
4. 维护
5. 不可扩展

客户机怎样决定主机名 www.amazon.com 的 IP 地址：
1. 客户机查询根服务器得到 com DNS 服务器
2. 客户机查询 com DNS 服务器得到 amazon.comDNS 服务器
3. 客户机查询 amazon.comDNS 服务器得到 www.amazon.com 的 IP 地址

- 根名字服务器：记录顶级域名服务器的信息
- 顶级域服务器：负责顶级域名 com, org, net, edu, etc, 和所有国家的顶级域名 uk, fr, ca, jp.
- 权威 DNS 服务器: 在因特网上具有公共可访问主机（如 Web 服务器和邮件服务器）的每个组织机构提供公共可访问的 DNS 记录，这些记录将这些主机的名字映射为 IP 地址。
- 本地 DNS 服务器（不属于服务器层次结构）：每个 ISP 都有一个本地 DNS，主机发出的 DNS 请求发往本地 DNS 服务器；起代理作用，转发请求到层次结构中

DNS 查询方法：
1. 递归查询：名字解析的负担交给被查询的名字服务器
	![|250](image/Pasted%20image%2020250601212538.png)
2. 迭代查询：被查询的名字服务器，回复可以被查询的名字服务器的 IP 地址
	![|250](image/Pasted%20image%2020250601213107.png)

DNS 缓存：一旦名字服务器获得 DNS 映射时，缓存该映射到局部内存
- 服务器一定时间后丢弃缓存的信息
- 本地 DNS 服务器缓存 TLD 服务器 IP 地址：根 DNS 服务器不会被经常访问

权威 DNS 服务器记录更新：IETF 动态更新/通报机制

DNS 存储资源记录（RR）的分布式数据库：
RR 格式：（name, value, type, ttl）

| type  | name       | value         |
| ----- | ---------- | ------------- |
| A     | 主机名        | IP 地址          |
| CNAME | 主机别名       | 真实的规范主机名      |
| NS    | 域名         | 该域权威名字服务器的主机名 |
| MX    | 邮件服务器的主机别名 | 邮件服务器的真实规范主机名 |

DNS 协议：查询报文、应答报文，具有相同的报文格式
![|300](image/Pasted%20image%2020250601214636.png)
报文头部：
- 标识符: 16 位，查询和应答报文使用相同的标识符
- 标志：有若干个标志构成，分别标识不同的功能
	- 查询/应答－0/ 1
	- 查询希望是/非递归查询－1/0
	- 应答可/否获得 (支持) 递归查询－1/0
	- 应答是/否来自权威名字服务器－1/ 0
- 问题部分：查询的 Name, type
- 回答部分：对于查询，应答的资源记录可以多个资源记录，由于可以有多个 IP 地址
- 权威部分：域对应的权威名字服务器的信息
- 附加信息部分：权威名字服务器的 IP 地址等其他有帮助的记录

DNS 数据库中插入记录（注册 network.com）：
1. 需要提供自己的基本权威 DNS 服务器和辅助权威 DNS 服务器的名字和 IP 地址
2. 该注册登记机构将下列两条资源记录插入注册机构的 DNS 系统中：
	(network.com, dns1.network.com, NS)
	(dns1.network.com, 212.212.212.1, A)

DNS 攻击：
- DDoS 攻击：对根域名服务器或顶级域名服务器发起拒绝服务攻击
- 重定向攻击：中间人攻击、DNS 中毒攻击（发送欺骗的域名解析结果给 DNS 服务器）
- 利用 DNS 实现 DDoS 攻击： DNS 反弹式拒绝服务攻击 (DNS reflector attacks，又称 DNS amplification attacks)。伪造客户地址向大量的 dns 服务器发出请求，导致客户无法访问 dns 服务器进行域名解析
- 本机 Host 文件被篡改
- DNS 劫持
- DNS 污染

如何从海量的视频中，挑选出某些内容，采用流的方式发送给成千上万的用户：
- 使用单点，庞大服务器坏处：
	1. 单点故障
	2. 单点网络拥塞
	3. 远距离用户的访问路径长
	4. 输出链路上发送同一视频的多分重复拷贝
	5. 不具有可扩展性
- 内容分发网络 (Content distribution networks, CDN) ：将多份拷贝存储在地理上分散的不同站点来提供服务；用户向 CDN 请求内容，被定向到附近的拷贝，取得内容；如果网络路径拥塞，则可能选择其他的拷贝
	1. 深入：将 CDN 服务器部署在众多的接入网络中（靠近用户）
	2. 邀请做客：在少量靠近接入网的关键位置（如 IXP），建造大集群，邀请到 ISP 做客

# 3. 传输层
**传输层服务和协议**：
- 在两个不同的主机上运行的应用程序之间提供**逻辑通信**
- 传输层协议运行在端系统
	- 发送方: 将应用程序报文分成数据段传递给网络层
	- 接受方: 将数据段重新组装成报文传递到应用层
- 不只一个传输层协议可以用于应用程序: TCP 和 UDP

传输层：两个进程之间的逻辑通信（可靠, 增强的网络层服务）
网络层: 两个主机之间的逻辑通信
可靠按序递交 (TCP)：拥塞控制、流量控制、连接建立
不可靠的无序传递（UDP）：“尽力传递” IP 的直接扩展
不提供的服务：延迟保证、带宽保证

**多路复用和多路分解**：
![|400](image/Pasted%20image%2020250613211325.png)
- 在接收主机多路分解：将接收到的数据段传递到正确的套接字（多路分解）
- 在发送主机多路复用：从多个套接字收集数据, 用首部封装数据，然后将报文段传递到网络层 (多路复用）

多路分解工作：
- 主机收到 IP 数据报
	- 每个数据报有源 IP 地址，目的 IP 地址
	- 每个数据报搬运一个数据段
	- 每个数据段有源和目的端口号  （对于特定应用程序具有周知端口号)
- 主机用 IP 地址和端口号指明数据段属于哪个合适的套接字

无连接多路分解：
- 用端口号创建套接字
- UDP 套接字由两个因素指定：(目的 IP 地址, 目的端口号)
- 当主机收到 UDP 数据段:
	1. 检查数据段中的目的端口号
	2. 用端口号指示 UDP 数据段属于哪个套接字
- 具有不同的源 IP 地址且/或源端口号，但具有相同的目的 IP 地址和目的端口号的 IP 数据报，指向同样的套接字

面向连接的多路分解：
TCP 套接字由 4 部分指定：源 IP 地址、源端口号、目的 IP 地址、目的端口号
接收主机使用所有四个值将数据段定位到合适的套接字
服务器主机可同时支持很多个 TCP 套接字:
- 以 Web 服务器为例：对每个连接的客户都有不同的套接字
- 非持久 HTTP 将对每个请求有一个不同的套接字

**UDP**：
- “无修饰” “不加渲染的” 因特网传输层协议，只在 IP 的数据报服务之上增加了端口功能、差错检测功能
- “尽最大努力”服务
- 数据段可能：丢失、会传递失序的报文到应用程序
- 无连接:
	- 在 UDP 接收者发送者之间没有握手
	- 每个 UDP 数据段的处理独立于其他数据段
好处：
1. 不需要建立连接 (减少延迟)
2. 简单: 在发送者接受者之间不需要连接状态
3. 很小的数据段首部
4. 没有拥塞控制: UDP 能够用尽可能快的速度传递

UDP 是面向报文的：
- 发送方 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层。UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。
- 接收方 UDP 对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程，一次交付一个完整的报文。
![|425](image/Pasted%20image%2020250613213423.png)


UDP 基于端口的多路分解：
![|425](image/Pasted%20image%2020250613213611.png)

用户数据报 UDP 有两个字段：数据字段和首部字段。首部字段有 8 个字节，由 4 个字段组成，每个字段都是两个字节。长度是首部和数据的总长度
![|475](image/Pasted%20image%2020250613213758.png)

在计算检验和时，临时把“伪首部”和 UDP 用户数据报连接在一起。伪首部仅仅是为了计算检验和。
![|500](image/Pasted%20image%2020250613214006.png)
- 伪首部中的 UDP 长度，和首部中的长度一致

UDP 校验和与差错检测：
![|500](image/Pasted%20image%2020250613214545.png)

UDP 校验和：
目标: 对传输的数据进行差错检测
- 发送方：将数据段看成 16bit 的整数序列，将校验和值放入 UDP 的校验和域
	校验和: 数据段内容相加 (1 的补码和，即反码)
- 接收方：计算接收到数据段的校验和，检查计算的校验和是否等于校验和域中的值:
	- NO – 检测到错误
	- YES – 没有检测到错误（但是可能是错误的）
![|350](image/Pasted%20image%2020250613214953.png)
- 求和时产生的进位必须回卷加到结果上
- 最后的累加和必须==**按位变反**==才是校验和

**可靠数据传输**：
1. Rdt1.0: 完全可靠信道上的可靠数据传输
	- 在完美可靠的信道上：没有 bit 错误、没有分组丢失
	- 发送方，接收方分离的 FSMs :
		- 发送方发送数据到下层信道
		- 接收方从下层信道接收数据
	![|300](image/Pasted%20image%2020250613215253.png)
2. Rdt2.0: 具有 bit 错误的信道
	- 下层信道可能让传输分组中的 bit 受损：校验和将检测到 bit 错误
	- 如何从错误中恢复
		- 确认 (ACKs): 接收方明确告诉发送方 分组接收正确
		- 否认 (NAKs): 接收方明确告诉发送方 分组接收出错
		- 发送方收到 NAK 后重发这个分组
	- 在 rdt2.0 中的新机制 (在 rdt1.0 中没有的):
		- 差错检测
		- 接收方反馈: 控制信息 (ACK,NAK)   rcvr -> sender
	![|475](image/Pasted%20image%2020250613215636.png)
	停 - 等协议：发送方发送一个报文，然后等待接受方的响应
	缺陷：
	- ACK/NAK 混淆：发送方并不知道接收方发生了什么，重发可能重复
3. rdt2.1
	- 发送方处理混乱的 ACK/NAKs
		- 序号 加到分组上
		- 两个序号 (0,1) 就可以满足
		- 必须检查是否收到混淆的 ACK/NAK：状态加倍
		- 状态必须记住当前的分组是 1 号还是 0 号
		![|425](image/Pasted%20image%2020250613220737.png)
	- 接收方处理混乱的 ACK/NAKs
		- 必须检查是否接收到重复的分组
		- 状态指示 0 或者 1：是否希望的分组序号
		- 接收方并不知道它的上一个 ACK/NAK 是否被发送方正确收到
		![|500](image/Pasted%20image%2020250613220813.png)
4. rdt2.2: 一个不要 NAK 的协议
	- 同 rdt2.1 一样的功能, 只用 ACKs，不用 NAK, 如果上个报文接收正确接收方发送 ACK
	- 接收方必须明确包含被确认的报文的序号
	- 发送方收到重复 ACK 将导致和 NAK 一样的处理: 重发当前报文
	![|450](image/Pasted%20image%2020250613221258.png)
5. rdt3.0: 具有出错和丢失的信道
	- 假设: 下层信道还要丢失报文 (数据或者 ACKs)；校验和, 序号, 确认, 重发将会有帮助，但是不够
	- 方法: 发送者等待“合理的”确认时间
		- 如果在这个时间内没有收到确认就重发
		- 如果报文（或者确认）只是延迟 (没有丢失)：重发将导致重复，但是使用序号已经处理了这个问题，接受方必须指定被确认的报文序号
		- 要求倒计时定时器
		- 只有在定时器超时时才触发重发
	![|500](image/Pasted%20image%2020250613221526.png)

流水线技术：发送方允许发送多个 “在路上的”, 还没有确认的报文
- 序号数目的范围必须增加
- 在发送方/接收方必须有缓冲区
- 流水线技术的两个通用形式: go-Back-N, 选择重传

**Go-Back-N**：
- 发送方：
	- 在分组头中规定一个 k 位的序号
	- “窗口”, 允许的连续未确认的报文
	- ACK(n): 确认所有的报文直到（包含）序号 n - “累积 ACK”
		对第一个发送未被确认的报文定时
	- 超时 (n): 重发窗口中的报文 n 及以上更高序号的报文 (**只有一个**定时器记录最早的未被确认报文的发送时间)
- 接收方：
	- ACK-only: 总是为正确接收的最高序号的分组发送 ACK。可能生成重复的 ACKs，只需要记住被期待接收的序号
	- 接收到失序分组：丢弃 (不缓冲) -> 没有接收缓冲区，重发最高序号分组的 ACK

**选择性重传（SR）**：
- 接收方分别确认已经收到的分组：必要时，缓冲报文, 最后按序提交给上层
- 发送者只重发没有收到确认的分组：对每个没有确认的报文发送者都要启动一个定时器 (每个未被确认的报文都有一个定时器)
- 发送窗口：N 个连续序号，限制被发送的未确认的分组数量
![|550](image/Pasted%20image%2020250613231721.png)
- 发送方：
	- 从上层收到数据 : 如果下一个可用的序号在发送方窗口内，则将数据打包并发送，启动定时器
	- 超时 (n)：重发分组 n, 重启定时器
	- 收到 ACK(n) 在 [sendbase,sendbase+N-1] 内：标记分组 n 被接收，如果 n 是最小的未确认分组，则增加窗口基序号到下一个未被确认的序号
- 接收方：
	- 分组 n 的序号在 [rcvbase, rcvbase+N-1] 内
		- 发送 ACK(n)
		- 失序分组: 缓冲
		- 有序分组: 交付上层 (包括已经缓冲的有序分组), 提高窗口到下一个没有接收的分组
	- 分组 n 在 [rcvbase-N,rcvbase-1] 内：发送 ACK(n)
	- 其他：忽略

困境：是新一个分组还是一次重传
**窗口小于或等于序号空间大小的一半**

**TCP**：
- 点到点：一个发送者,一个接收者
- 可靠按序的字节流：没有“信息边界”
- 流水线：TCP 拥塞和流量控制设置窗口大小
- 收发缓冲区
- 全双工数据：同一个连接上的双向数据流
- MSS：最大报文段长
- 面向连接：在数据交换前握手 (交换控制信息) 初始化发送方和接收方的状态
- 流量控制：发送方不会淹没接收方
![|525](image/Pasted%20image%2020250614095500.png)
- 源端口和目的端口字段——各占 2 字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现。
- 序号字段——占 4 字节。TCP 连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。
- 确认号字段——占 4 字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。
- 数据偏移（即首部长度）——占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。“数据偏移”的单位是 32 位字（以 4 字节为计算单位）。
- 保留字段——占 6 位，保留为今后使用，但目前应置为 0。
- 紧急 URG (URGent)—— 当 URG = 1 时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送 (相当于高优先级的数据)。
- 确认 ACK(ACKnowledgment) —— 只有当 ACK = 1 时确认号字段才有效。当 ACK = 0 时，确认号无效。
- 复位 RST (ReSeT) —— 当 RST = 1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。
- 同步 SYN(SYNchronize) —— 同步 SYN = 1 表示这是一个连接请求或连接接受报文
- 终止 FIN (FINis) —— 用来释放一个连接。FIN = 1 表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。
- 窗口字段 —— 占 2 字节，用来让对方设置发送窗口的依据，单位为字节。
- 检验和 —— 占 2 字节。检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。
- 紧急指针字段 —— 占 16 位，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。
- 填充字段 —— 这是为了使整个首部长度是 4 字节的整数倍。

**TCP 序号的确认**：
- 序号：数据段中第一个字节在数据流中的位置编号
- 确认：期望从另外一边收到的下一个字节的序号
- 累计 ACK

**TCP 往返时延的估计和超时**：
如何设置 TCP 超时值：比 RTT 长；但 RTT 变化
- 太短:  不成熟的超时，不必要的重传
- 太长: 对数据段丢失响应慢
如何估计 RTT?
- 样本 RTT（SampleRTT）: 测量从报文段发送到收到确认的时间，忽略重传
- 样本 RTT 会变化,因此需要一个样本 RTT 均值（Estimated RTT），对收到的样本 RTT 要根据以下公式进行均值处理：
	EstimatedRTT = (1- a) X EstimatedRTT + a X SampleRTT
上述均值计算被称为: 指数加权移动平均，典型的: a = 0.125
设置超时：
- EstimtedRTT 加上 “安全余量”：EstimatedRTT 变化大 -> 更大的安全余量
- SampleRTT 偏离 EstimatedRTT 多少的估计
	DevRTT = (1-b) X DevRTT +b X | SampleRTT-EstimatedRTT |   (典型地, b = 0.25)
- 然后设置超时时间间隔:
	TimeoutInterval = EstimatedRTT + 4 X DevRTT
- 初始时 TimeoutInterval 设置为 1 秒
- 第一个样本 RTT 获得后， EstimatedRTT=SampleRTT，
	DevRTT=SampleRTT/2，
	TimeoutInterval = EstimatedRTT + max (G, K X DevRTT) （K=4，G 是用户设置的时间粒度）

**可靠数据传输**：
- TCP 在 IP 不可靠服务之上创建 rdt 服务
- 流水线技术处理报文段
- 累积确认
- TCP 使用单个重发定时器
- 触发重发：超时事件、重复确认

TCP 发送方事件：
1. 从应用程序接收数据：
	- 用序号创造一个报文，序号是报文中第一个数据字节在字节流中的位置编号
	- 如果没有启动定时器，则启动定时器，定时器是最早没有被确认的报文发送时启动的，设置超时间隔: TimeOutInterval
2. 超时：
	- 重发导致超时的报文
	- 重新开始定时器
3. 收到确认:
	- 如果 ACK 落在窗口之内，则确认对应的报文，并且滑动窗口
	- 若还有未确认的报文，重新开始定时器
![|625](image/Pasted%20image%2020250614103032.png)

**快速重传**：
- 超时触发重传存在问题: 超时周期往往太长——重传丢失报文之前要等待很长时间,因此增加了网络的时延
- 发送方可以在超时之前通过重复的 ACK 检测丢失报文段
	- 发送方常常一个接一个地发送很多报文段
	- 如果报文段丢失,则发送方将可能接收到很多重复的 ACKs
- 如果发送方收到一个确认后再收到 3 个对同样报文段的确认，发送方应意识到不对劲——生成三个重复 ACK，是因为接收方存在缺失报文段
- 启动快速重传: 在定时器超时之前重发丢失的报文段
说明：
- TCP 类似 GBN，但是它的接收方也缓存失序报文段
- 可以引入 SACK(选择确认) 机制（需要借助 TCP 头部中的选项字段来实现）
- 总体来说，TCP 是 GBN 和 SR 的混合体

**TCP 流量控制**：
![|350](image/Pasted%20image%2020250614104029.png)
TCP 连接的接收方有一个接收缓冲区：应用程序可能从这个缓冲区读出数据很慢
速度匹配服务：发送速率和接收应用程序的提取速率匹配
流量控制：发送方不能发送的太多太快，让接收缓冲区溢出
(假设 TCP 接收方丢弃失序的报文段)
- 流量控制使用接收窗口（发送方维护）：接收缓冲区的剩余空间
- 接收方在报文段中宣告接收窗口的剩余空间
- 发送方限制没有确认的数据不超过接收窗口：保证接收缓冲区不溢出

**TCP 连接管理**：
三次握手：
1. 客户发送 TCP SYN 报文段到服务器
	- 指定初始的序号
	- 没有数据
2. 服务器接收 SYN, 回复 SYN/ACK 报文段
	- 服务器分配缓冲区
	- 指定服务器的初始序号
3. 客户接收 SYN/ACK, 回复 ACK 报文段, 可能包含数据
![|525](image/Pasted%20image%2020250614105845.png)

四次挥手：
1. 客户发送 TCP FIN 控制报文段到服务器
2. 服务器接收 FIN, 回复 ACK. 进入半关闭连接状态；
3. 服务器发送 FIN 到客户，客户接收 FIN, 回复 ACK，
	进入 “time wait”状态
	等待结束时释放连接资源
4. 服务器接收 ACK.  连接关闭.
![|525](image/Pasted%20image%2020250614110423.png)

![|550](image/Pasted%20image%2020250614110633.png)

![|425](image/Pasted%20image%2020250614110706.png)

**拥塞控制原理**：
拥塞：从信息角度看: “太多源主机发送太多的数据，速度太快以至于网络来不及处理”（流量控制不同）
表现:
- 丢失分组 (路由器的缓冲区溢出)
- 长延迟 (在路由器的缓冲区排队)
1. 场景 1：两个发送方和一台具有无穷大缓存的路由器
	![|400](image/Pasted%20image%2020250614111558.png)
	- 每个主机最大可达吞吐量 C/2,总的吞吐量为 C
	- 但是，拥塞时延在 C/2 达到无限大
2. 场景 2：两个发送方和一台具有有限缓存的路由器
	![|475](image/Pasted%20image%2020250614112123.png)
	- 发送方以重传补偿缓存溢出而丢弃的分组
	- 遇到大时延时，进行不必要的重传引起路由转发不必要的分组副本
3. 场景 3：4 个发送方和具有有限缓存的多台路由器及多跳路径
	![|550](image/Pasted%20image%2020250614112406.png)
	当分组丢失后， 任何上游路由器的发送能力都浪费了

拥塞控制的方法：
1. 端到端拥塞控制：
	- 没有从网络中得到明确的反馈
	- 从端系统观察到的丢失和延迟推断出拥塞
	- TCP 采用的方法
2. 网络辅助的拥塞控制:
	- 路由器给端系统提供反馈
	- 单 bit 指示拥塞 (SNA, DECnet, TCP/IP ECN, ATM)
	- 指明发送者应该发送的速率

**TCP 拥塞控制**：
1. 端到端控制 (没有网络辅助)
	发送方限制发送：
	LastByteSent-LastByteAcked < min( CongWin , RcvWindow )
	大体上，rate = CongWin / RTT Bytes/sec
	CongWin 是动态的, 感知的网络拥塞的函数
2. 发送方感知拥塞：
	丢失事件 = 超时或者 3 个重复的 ACKs
	TCP 发送方在丢失事件发生后降低发送速率 (CongWin)
3. TCP 拥塞控制算法：
	- 慢启动
	- 拥塞避免
	- 快速恢复

TCP 慢启动：
- 连接开始的时候, CongWin = 1 MSS
- 有效带宽将 >> MSS/RTT，以 2 的指数方式增加速率
	- 若超时丢包，cwnd = 1，ssthresh = cwnd/2
	- 若达到某个阈值 ssthresh，进入拥塞避免
	- 收到三个重复的 ACK ：ssthresh = cwnd/2，cwnd 减半 + 3 (Reno 版)，进入快速恢复
- 总结: 初始速率慢但是呈指数快速增长

拥塞避免：
- 逐步增长，每次增加一个 cwnd
- 若出现丢包：
	1. 超时丢包：cwnd = 1，ssthresh = cwnd/2，进入慢启动
	2. 收到三个重复的 ACK ：ssthresh = cwnd/2，cwnd 减半 + 3 (Reno 版)，进入快速恢复

快速恢复：
- 收到一个冗余 ACK -> cwnd 增加一个 MSS
- 当丢失报文段的一个 ACK 到达，cwnd = ssthresh ，进入拥塞避免
- 若超时，cwnd = 1，ssthresh = cwnd/2，进入慢启动
![|400](image/Pasted%20image%2020250614135806.png)

![|550](image/Pasted%20image%2020250614140214.png)
- 当 CongWin 低于阀值, 发送方处于慢启动阶段, 窗口指数增长.
- 当 CongWin 高于阀值, 发送方处于拥塞避免阶段, 窗口线性增长.
- 当三个重复的 ACK 出现时,阀值置为 CongWin/2 并且 CongWin 置为阀值加上 3 个 MSS 并进入快速恢复阶段，此时每收到一个重复的 ACK 拥塞窗口增加 1MSS，如果收到新的 ACK 则拥塞窗口置成阀值）.
- 当超时发生时 ，阀值置为 CongWin/2 并且 CongWin 置为 1 MSS.

TCP AIMD（加性增、乘性减）：
发送方增加传输速率（窗口大小），探测可用带宽，直到发生丢包事件
乘性递减: 发生丢包事件后将拥塞窗口减半
加性递增: 每个 RTT 内如果没有丢失事件发生，拥塞窗口增加一个 MSS
![|475](image/Pasted%20image%2020250614140543.png)

**明确拥塞通告**：
TCP 的部署也可以使用网络辅助拥塞控制：
- 路由器标记 IP 报头（ToS 字段）中的两个比特，用于指示拥塞，具体策略由运营商决定
- 拥塞指示被传送到目的地
- 接收方在 ACK 报文段上设置 ECE 位，以通知发送方拥塞
- 包括 IP（IP 头 ECN 位标记）和 TCP（TCP 头 C、E 位标记）
![|500](image/Pasted%20image%2020250614141302.png)

**基于时延的 TCP 拥塞控制**：
TCP（传统的 Tahoe/Reno, CUBIC）提高 TCP 的发送速率，直到某些路由器的输出出现数据包丢失——此路由器即为瓶颈链路
![|550](image/Pasted%20image%2020250614141359.png)
![|575](image/Pasted%20image%2020250614141512.png)

# 4. 网络层
网络层提供的功能：
1. 从发送方主机传输报文段到接收方主机
2. 发送方主机封装报文段 (segments) 为数据报 (datagrams)
3. 接收方主机递交报文段给传输层
4. 在每个主机、路由器上都需要运行网络层协议
5. 路由器会检查通过它的所有 IP 数据报的头部字段，然后根据目的 IP 地址对数据报进行转发

主要功能：
1. 转发 (forwarding): 将分组从路由器的输入端口转移到正确的路由器输出端口
2. 路由 (routing): 确定分组从发送方传输到接收方 (目的主机) 所经过的路径 (或路由) -> 路由算法
路由算法确定通过网络的端到端路径
转发表确定本路由器上的本地转发

- 数据平面
	- 本地的，每个路由器自身的功能
	- 决定抵达路由器输入端口的数据包如何转发到输出端口
- 控制平面
	- 整个网络范围
	- 决定数据报在端到端路径上的路由器之间如何路由
	- 两种数据平面的实现方式：
		- 传统的路由算法: 每个路由器都有单独的路由算法组件，路由器之间通过交互来实现控制平面
		- 软件定义网络（software-defined networking, SDN): 一个分离的（通常是远程的）控制器和路由器本地的控制代理 (local control agents，CAs) 交互

网络层可能提供的服务：
1. 确保交付：确保分组到达目的地。
2. 具有时延上界的确保交付：主机到主机的时延。
3. 有序分组交付：按发送顺序到达。
4. 确保最小带宽：当发送主机以低于特定比特率的速率发送比特，分组不会丢失，在一定时延到达。
5. 确保最大时延抖动：发送方发送两个连续分组的时间间隔与接收到的间隔相同。

因特网的网络层提供的服务：
1. 单一服务，即尽力而为服务 (best-effort service) 。
2. 分组间的定时不能被保证；
3. 分组的接收顺序与发送顺序不一定相同；
4. 传送的分组不能保证最终交付，即网络可能未向目的地交付分组。

数据报网络：提供网络层的无连接服务
虚电路网络：提供网络层的连接服务
类比于 TCP/UDP 的面向连接/ 无连接的传输层服务：任何网络中的网络层只提供两种服务之一，不会同时提供。
传输层：面向连接服务在网络边缘的端系统中实现。
网络层：面向连接服务在端系统及网络核心的路由器中实现。

**数据报网络**：
- 在网络层无呼叫的过程
- 路由器： 不需要维护端到端连接的状态
- 没有网络等级的“连接”的概念
- 使用目的主机的地址进行分组转发

**数据报网络的特点**：
1. 由互连计算机的需求发展而来。与电话网相反。
2. 网络层服务模型简单。
3. 端系统功能复杂：高层实现许多功能，如按序传送、可靠数据传输、拥塞控制与 DNS 名字解析等；
4. 带来的结果：因特网服务模型提供的服务保证最少，对网络层的需求最小，使得互连使用各种不同链路层技术的网络变得更加容易。
5. 许多应用都在位于网络边缘的主机（服务器）上实现。

路由器的两个核心功能：
1. 运行路由算法/协议 (OSPF, RIP, BGP)
2. 将分组从路由器的输入链路传送到正确的输出链路。
路由器的体系结构：
![|575](image/Pasted%20image%2020250614143044.png)

输入端口：
![|525](image/Pasted%20image%2020250614143332.png)
1. 线路端接模块：将一条物理链路端接到路由器的物理层；
2. 数据链路处理模块：实现路由器的数据链路层功能；
3. 查找与转发模块：实现查找与转发功能，以便分组通过路由器交换结构转发到适当的输出端口；
	确定将一个到达的分组通过交换结构转发给哪个输出端口。 通过查找转发表实现，这里的转发表是存储在输入端口的内存中。
	分布式交换：
	- 选路处理器计算转发表，给每个输入端口存放一份转发表拷贝。
	- 在每个输入端口本地做出交换决策，无须激活中央选路处理器。
	- 可避免在路由器中某个单点产生转发处理瓶颈。
	- 目的：以线速完成输入端口的处理
	- 排队：如果数据报到达输入端口的速度快于输入端口将数据报转发到交换结构的速度，就会发生排队 -> 会导致排队延时和由于输入缓冲区溢出导致的丢包
	- 线头阻塞（Head-of-the-Line (HOL) blocking）: 在队列前面的被阻塞的数据报会阻止队列中的其他数据报被转发。
	![|550](image/Pasted%20image%2020250614144707.png)

交换结构：
将分组从输入端口缓存交换（转发）到恰当的输出端口缓存中
三种类型的交换结构：
![|550](image/Pasted%20image%2020250614143657.png)、
1. 经内存的交换结构
	- 早期用计算机作为路由器时采用的结构 (第一代)
	- 输入端口与输出端口之间的交换由 CPU(选路处理器) 控制完成；
	- 输入端口与输出端口类似 I/O 设备：
		- 当分组到达输入端口时，通过中断向选路处理器发出信号，将分组拷贝到处理器内存中；
		- 选路处理器根据分组中的目的地址查表找出适当的输出端口，将该分组拷贝到输出端口的缓存中。
	- 转发速度：
		- 交换速度受总线带宽的速度限制 (每个分组穿过两次总线)
		- 若总线带宽为每秒写入或读出 B 个分组，则总的转发吞吐量 (分组从输入端口被传送到输出端口的总速率) 小于 B/2。
2. 经总线的交换结构
	输入端口通过一条共享总线将分组直接传送到输出端口，不需要选路处理器的干预。
	- 每次只能有一个分组通过总线传送。
	- 分组到达一个输入端口时，若总线正忙，会被暂时阻塞，在输入端口排队
	- 路由器交换带宽受总线速率限制。
3. 经交换矩阵交换结构
	- 纵横式交换机：由 2n 条总线组成，n 个输入端口与 n 个输出端口连接。
	- 到达输入端口的分组沿水平总线穿行，直至与所希望的输出端口的垂直总线交叉点：
	- 若该条垂直总线空闲，则分组被传送到输出端口；
	- 否则，该到达的分组被阻塞，必须在输入端口排队。
	高级设计: 数据报分割成固定长度信元, 通过交换矩阵来交换信元

输出端口：
![|500](image/Pasted%20image%2020250614144255.png)
- 取出存放在输出端口内存中的分组，并将其传输到输出链路上。
- 排队：当交换结构将分组交付给输出端口的速率超过输出链路速率，就需要排队与缓存管理功能。当输出端口的缓冲区溢出时，就会出现延时和丢包。
	![|550](image/Pasted%20image%2020250614144823.png)
- 管理缓存中的数据包——包调度（packet scheduling)
	- FCFS(FIFO)
	- 基于优先级的调度
	- Round Robin
	- 加权公平排队（Weighted Fair Queuing , WFQ）

**IP 数据报（IPv4）**：
![|525](image/Pasted%20image%2020250614145129.png)

**IP 数据报分片和重组**：
![|350](image/Pasted%20image%2020250614145330.png)
- 每个数据链路有自己的 MTU，链路类型不同，MTU 的值也不同，这里 MTU 指的是数据链路帧的数据区的最大字节数
- 在因特网中，一个大的分组可能在路由器中被分割为几个分片，在最终的目的主机上，将这些分片重新组装成一个大的分组
- 为了进一步识别出这些分组，需要对分片进行标识

- **IP 地址**：分配给主机或路由器接口的标识符
- 接口: 主机/路由器与物理链路之间的边界
	- 路由器有多个接口
	- 主机可以有多个接口
	- 每个接口有一个 IP 地址
- IP 地址有两种：IPV4 和 IPV6
	- IPV4：32 个二进制位长（4 字节），常用点分十进制表示；将 4 个字节中的每一个字节分别用十进制数来表示，4 个十进制数之间用 “.” 分隔
	- IPV6：128 个二进制位长（16 字节）常用冒号分隔表示

IP 地址结构包括两部分：
- 网络号：指明主机所在网络的编号。
- 主机号：主机在网络中的编号。

特殊 IP 地址段：
1. 本地回环地址：用来识别主机本身的地址
2. 私有地址：局域网使用的地址段，公网上不能路由
3. 0.0.0.0：标识不清楚的网络和主机
4. 255.255.255.255：受限的广播地址，一个网段内的所有主机

互联网中的 IP 地址：
- 同一局域网上的主机或路由器的 IP 地址中的网络号必须相同
- 交换机互连的网络仍然是一个局域网，只能有一个网络号。
- 路由器总是具有两个或两个以上 IP 地址。
- 当两个路由器直接相连时，在连线两端的接口处，可以指明 IP 地址也可以不指明 IP 地址。

**划分子网**：
![|275](image/Pasted%20image%2020250614150805.png)
- 网络号相同的 IP 地址属于同一个网络。而网络还可以划分为若干子网（subnet）。
- 划分子网的方法是从主机号借用若干个比特作为子网号，剩下的主机位为主机号

子网：
- 设备接口的 IP 地址具有同样的网络部分
- 没有路由器的介入，物理上能够相互到达

子网掩码：
- 子网号字段长度是可变的，为了确定子网地址，IP 协议提供了子网掩码的概念 。
- 子网掩码用来确定网络地址（包括网络号和子网号）和主机地址的长度。子网掩码长为 32 位比特，其中的 1 对应于 IP 地址中的网络号和子网号，而子网掩码中的 0 对应于主机号。

使用子网划分后，路由表中将包括三项：目的网络地址、子网掩码和下一跳地址，例如：
![|350](image/Pasted%20image%2020250614151430.png)

**无分类域间路由（CIDR）**：
![|353](image/Pasted%20image%2020250614151547.png)
- 在 IP 地址后面加上一个斜线“/”，斜线后面用一个数字指定网络前缀的长度。
- CIDR 将网络前缀都相同的连续的 IP 地址组成“CIDR 地址块”

获取 IP 地址：
- 手工指定（保存到系统配置中）
- DHCP：自动从 DHCP 服务器得到

**DHCP**工作过程：
1. DHCP 服务器被动打开 UDP 端口 67，等待客户端发来的报文。
2. DHCP 客户从 UDP 端口 68 发送 DHCP 发现报文。
3. 凡收到 DHCP 发现报文的 DHCP 服务器都发出 DHCP 提供报文，因此 DHCP 客户可能收到多个 DHCP 提供报文。
4. DHCP 客户从几个 DHCP 服务器中选择其中的一个，并向所选择的 DHCP 服务器发送 DHCP 请求报文。
5. 被选择的 DHCP 服务器发送确认报文 DHCPACK，客户进入已绑定状态，并可开始使用得到的临时 IP 地址了。
	DHCP 客户现在要根据服务器提供的租用期 T 设置两个计时器 T1 和 T2，它们的超时时间分别是 0.5T 和 0.875T。当超时时间到就要请求更新租用期。
6. 租用期过了一半（T1 时间到），向 DHCP 发送请求报文 DHCPREQUEST 要求更新租用期。
7. DHCP 服务器若不同意，则发回否认报文 DHCPNACK。这时 DHCP 客户必须立即停止使用原来的 IP 地址，而必须重新申请 IP 地址（回到步骤 2）
8. DHCP 服务器若同意，则发回确认报文 DHCPACK。DHCP 客户得到了新的租用期，重新设置计时器。
	若 DHCP 服务器不响应步骤 6 的请求报文 DHCPREQUEST，则在租用期过了 87.5% 时，DHCP 客户必须重新发送请求报文 DHCPREQUEST（重复步骤 6），然后又继续后面的步骤。
9. DHCP 客户可随时提前终止服务器所提供的租用期，这时只需向 DHCP 服务器发送释放报文 DHCPRELEASE 即可。

DHCP 分配的不仅仅是 IP 地址，还可分配：
- 客户的第一跳路由器的地址（网关）
- DNS 服务器的 IP 地址或域名
- 子网掩码
- **DHCP 是应用层协议**

**NAT: 网络地址转换**
- 对外部网络来讲，本地网络只用一个 IP 地址
- 不需要从 ISP 分配一系列地址—— 只要一个 IP 地址用于所有设备
- 在本地网络，改变设备的 IP 地址不用通知外部世界
- 可以变更 ISP ，不用改变本地网络的设备的地址
- 本地网络内部设备不能被外部世界明确寻址，或是不可见 (增加了安全性)
![|500](image/Pasted%20image%2020250614153215.png)
执行 NAT，路由器必须做到:
- 外出的分组: 替换每个外出的分组的 (源 IP 地址, 端口号) 为 (NAT IP 地址, 新端口号) 
	远程客户/服务器用 (NAT IP 地址, 新端口号) 作为目的地来响应。
- (在 NAT 转换表中) 记录每个 (源 IP 地址, 端口号) 到 (NAT IP 地址, 新端口号) 转换配对
- 进来的分组: 对每个进来的分组，用保存在 NAT 表中的对应的 (源 IP 地址, 端口号) 替换分组中的目的域 (NAT IP 地址, 新端口号）
![|650](image/Pasted%20image%2020250614153825.png)

ICMP: (Internet Control Message Protocol，因特网控制报文协议）：
- 用于主机路由器之间彼此交流网络层信息
	- 差错报告: 不可到达的主机, 网络,端口,协议
	- 请求/应答 (用于 ping,traceroute)
- 位于 IP 之上：因为 ICMP 消息是装载在 IP 分组里的
- Traceroute 和 ICMP
1. 源端发送一系列的 UDP 分组给目的端
	- 第一个分组  TTL =1
	- 第二个 TTL=2, 等等
2. 当第 n 个分组到达第 n 个路由器时
	- 路由器丢弃该分组
	- 并给源端发送一个 ICMP 报文 (type 11, code 0)
	- 这个报文包含了路由器的名称和 IP 地址
3. 当源端收到 ICMP 报文时，计算传输往返时间 RTT
	- 对每个 TTL 作三次

停止发送的依据：
1. UDP 报文最终到达目的端
2. 目的端返回回应应答的 ICMP 报文 (type 3, code 3)
3. 源端停止发送

IPv6 地址表示：
- 冒号十六进制表示法
	104.220.136.100.255.255.255.255.0.0.18.128.140.10.255.255 ->
	69DC:8864:FFFF:FFFF:0:1280:8C0A:FFFF
- 零压缩表示法：FF0C::B1

路由：
- 默认路由器：与主机直接相连的路由器，又叫第一跳路由器。每当主机发送一个分组时，都先传送给它的默认路由器。
- 源路由器：源主机的默认路由器。
- 目的路由器：目的主机的默认路由器。
- 从源主机到目的主机的选路归结为从源路由器到目的路由器的选路。
- 路由算法：是确定一个分组从源路由器到目的路由器所经路径的算法
- 路由算法的关键：在给定的一组路由器以及连接路由器的链路中，找到一条从源路由器到目的路由器的“好”路径。

层次选路：
- 一个区域内的路由器组成集合 “自治系统” (AS，autonomous system )
- 同一个自治系统的路由器运行相同的路由协议——区域内路由协议，也被称作内部网关协议 (IGP)
- 不同自治系统内的路由器可以运行不同的区域内路由协议
网关路由器：
- 和其他自治系统内的路由器直接相连的路由器
	运行域间路由协议，与其他网关路由器交互
- 同自治系统内的所有其他路由器一样也运行域内路由协议

标准的域内路由协议:
- RIP: 路由信息协议
- OSPF: 开放式最短路径优先
- IGRP: 内部网关路由协议 (Cisco 所有)

OSPF(Open Shortest Path First)：
- open”: 开放、公用的
- 用链路状态算法
	- 分发 LS 分组
	- 每个节点具有拓扑图
	- 路由计算使用 Dijkstra 算法
- 每个 router 都广播 OSPF 通告，OSPF 通告里为每个邻居路由器设一个表项（记录每个邻居的链路特征和费用）。
- 通告会散布到 整个 自治系统 (通过洪泛法)
	- OSPF 信息直接通过 **IP** 传输 (不是 TCP 或 UDP）
优点：
1. 安全: 所有 OSPF 消息需要认证 (防止恶意入侵)
2. 允许多个相同开销的路径 (在 RIP 中只有一条路径)
3. 对于每个链路, 有多个消费尺度用于不同的服务类型 TOS (例如在尽力转发时卫星链路代价设置为 “低” ，而对实时应用设置为高)
4. 单播和多播综合支持:
	1. 多播 OSPF (MOSPF) 使用和 OSPF 同样的链路数据库
	2. 在大的区域中使用层次 OSPF

层次 OSPF：
![|400](image/Pasted%20image%2020250614155557.png)
- 两级层次: 本地区域, 主干区域（这些区域都是在一个自治系统内）
- 只在区域内发送链路状态通告
- 每个节点有详细的区域拓扑; 仅知道到达其他区域内网络的方向（即最短路径）
- 区域边界路由器（同时属于本地区域和主干区域）:“汇总”了到本区域内部网络的路径, 并通告给其他区域边界路由器.
- 主干路由器：限于在主干区域内运行 OSPF 路由协议（本身不是区域边界路由器）
- 边界路由器: 连接到其他自治系统

**Internet 域间选路: BGP**
- BGP (Border Gateway Protocol)：事实上的标准
- BGP 为每个 AS 提供了一种手段:
	- 从相邻 AS 获取子网可达信息
	- 向该 AS 内部的所有路由器传播这些可达性信息
- 基于该可达信息和 AS 策略，决定到达子网的“好”路由
- 允许一个子网向 Internet 的其他部分通告它的存在 “I am here”
AS 互连：
- 转发表根据 AS 内和 AS 间选路算法而配置
- AS 域内的选路项用于目的端在域内的选路。
- AS 域内和 AS 域间的选路项用于目的端在域外的选路。
AS 域间任务：
- AS1 需要知道:
	- 通过 AS2 和 AS3 可以到达哪些目的端
	- 将这些可达信息传播给 AS1 内的所有路由器
BGP 会话与通告：
- 路由器对（BGP 对等方）通过半永久 TCP 连接来交换选路信息：BGP 会话
- BGP 会话和物理链路无关（并不总是和某条物理链路对应）。
- 当 AS2 通告一个前缀给 AS1,说明 AS2 能够转发目的地址前缀是这个通告前缀的所有分组。
- AS2 能够在它的通告中汇总了这些前缀。
传播可达信息：
![|350](image/Pasted%20image%2020250614160613.png)
- 在 3A 和 1C 的 eBGP 会话中，AS3 向 AS1 通告一个前缀可达信息。
- 1c 通过 iBGP 会话向 AS1 中的所有路由器发布这个新的前缀可达信息。
- 1b 又将这个可达信息通过 1b 和 2a 之间的 eBGP 会话通告给 AS2。
- 当路由器得知一个新的前缀时，就在它的转发表中为该前缀创建一个项。
路径属性 和 BGP 路由：
- 当通告前缀时，通告包含了 BGP 属性.
- 前缀 + 属性=“路由”
- 两个重要的属性:
	- AS-PATH: 包含了前缀的通告已经通告过的那些 AS,如 AS 67 AS 17
	- NEXT-HOP: 指出到达下一个 AS 的具体 AS 间边界路由器（可能存在多条从当前 AS 到达下一个 AS 的链路）
- 当网关路由器接收到路由通告时，使用输入策略来决定接收/舍弃该通告。
BGP 路由选择：
- 路由器可能知道到相同前缀的多条路由，路由器必须从中选择.
- 排除规则（应用排除规则直到有一条留下）
	- 本地偏好值属性: 具有最高偏好值的路由被选择
	- 最短 AS-PATH 的路由
	- 最靠近 NEXT-HOP 路由器的路由 : 热土豆路由
	- 其他标准
BGP 报文：
- BGP 报文交换使用 **TCP**
- BGP 报文:
	- OPEN: 建立到对方的 TCP 连接，并对发送者进行认证
	- UPDATE: 通告新路径 (或者撤销旧路径)
	- KEEPALIVE: 在没有 UPDATES 时保持连结活跃; 也对 OPEN 请求作出应答
	- NOTIFICATION: 报告前面报文的错误; 也用于关闭连结

为什么 AS 内选路和 AS 间选路采用不同的协议 ?
1. 策略:
	1. AS 间: 管理员想控制本 AS 内产生的通信流怎样选路，以及什么通信流穿过自己的网络
	2. AS 内: 单个管理者, 因此不需要策略
2. 规模:
	1. 层次路由节省了转发表的大小空间，减少了路由更新的流量
3. 性能:
	1. AS 内: 集中在性能上
	2. AS 间: 策略可能比性能更加重要

SDN：通用转发
SDN 的核心思想是建立一个通用转发体系——每个交换设备包含一个**流表** (flow table). 流表由一个逻辑上中心化的控制器（远程控制器）来计算和分发
特征：
1. 基于流的转发
2. 数据平面与控制平面分离
3. 网络控制功能：位于数据平面交换机外部
4. 可编程的网络

**算法**：
1. 最长前缀匹配
2. 子网划分（掩码、CIRD）
3. 路由算法：
	1. 全局路由算法：LS
	2. 分布式路由算法：DV

# 5. 数据链路层
数据链路层的职责：将数据报从一个节点传送到与该节点直接有物理链路相连的另一个节点。
术语：
- 主机、路由器：节点
- 沿着通信路径相邻节点的通信信道：链路（有线/无线链路）
- 第二层的分组：数据帧，是封装了的数据报

- 数据报可以在不同的链路上，通过不同的链路层协议发送
- 每个链路层协议提供不同的服务（可以提供可靠/不可靠数据传输服务）

**链路层提供的服务**：
1. 封装成帧，链路接入
	1. 封装数据报为数据帧，增加头部、尾部信息
	2. 如果是共享链路，接入链路
	3. 在数据帧头部中，用 MAC 地址来标识源目的 MAC 地址
2. 在相邻节点之间可靠传输数据帧
	1. 在比特错误率很低的链路（光纤、双绞线）很少使用
	2. 无线链路：高比特错误率
3. 流量控制
	用于控制发送节点向直接相连的接收节点发送数据帧的频率
4. 差错检查
	1. 差错可能由信号衰减、噪声引入
	2. 接收方检测是否出现错误：通知发送方重传或丢弃数据帧
5. 错误纠正
	接收方标识和纠正比特错误，不需要请求重传
6. 半双工和全双工
	在半双工模式，链路的两个节点都可以发送数据，但是不能同时发送

**链路层实现的位置**：
- 在主机和网络设备（路由器）上实现
- 在主机上，链路层主体部分是在网络适配器上实现的（称网卡）
	- 以太网卡；以太网芯片组
	- 实现链路层和物理层的功能
- 硬件、软件、固件的组合

**网络适配器**：
1. 发送方：
	- 封装数据报为数据帧
	- 增加差错检测比特，可靠数据传输，流量控制等机制
2. 接收方：
	- 执行检查错误、可靠数据传输、流量控制等机制
	- 抽取数据报，将其递交给上层

**差错检测和纠错技术**：
- 比特级差错检测和纠错：对一个节点发送到一个相邻节点的帧，检测是否出现比特差错，并纠正
- 差错检测并非 100% 可靠
	- 协议可能丢失一些错误
	- 差错校验位越多，检测和纠正功能越好
- 发送节点
	- 将数据 D 附加若干差错检测和纠错位 EDC，一起发送到链路
	- 数据 D 包括网络层传来的数据报，以及链路级寻址信息、序列号和其他字段
	- 保护范围包括数据 D 的所有字段
- 接收节点
	- 接收比特序列 D' 和 EDC'
	- 如果发生传输比特错误（0→1，1→0），D' 和 EDC' 可能与发送的 D 和 EDC 不同
	- 接收方根据 D' 和 EDC'，判断 D' 是否和初始的 D 相同（D 的传输是否正确）
		- 正确：解封取出数据报，交给网络层
		- 出错：差错处理
- NOTE
	- 差错检测和纠正技术不能保证接收方检测到所有的比特差错，即可能出现未检测到的比特差错，而接收方并未发现。
	- 选择一个合适的差错检测方案使未检测到的情况发生的概率很小即可。
	- 差错检测和纠错技术越好，越复杂，开销更大。

**多路访问链路和协议**：
- 两种网络链路：
	- 点对点链路：链路两端各一个节点。一个发送和一个接收。如点对点协议 PPP。
	- 广播链路： 多个节点连接到一个共享的广播信道。
广播：任何一个节点传输一帧时，信号在信道上广播，其他节点都可以收到一个拷贝。常用于局域网 LAN 中，如早期的以太网和无线局域网。

**广播信道要解决的问题**：
- 传统的广播电视：是单向的广播，一个固定的节点向许多接收节点发送。
- 计算机网络：广播信道上的节点都能够发送和接收。
- 多路访问问题：如何协调多个发送和接收节点对共享广播信道的访问。相关技术即是多路访问协议（也称多址访问协议）。

**多路访问协议**：
- 目的：协调多个节点在共享广播信道上的传输。避免多个节点同时使用信道，发生冲突（碰撞），产生互相干扰。
- 冲突（collide）：两个以上的节点同时传输帧，使接收方收不到正确的帧（所有冲突的帧都受损丢失）。
	- 造成广播信道时间的浪费。
	- 多路访问协议可用于许多不同的网络环境，如有线和无线局域网、卫星网等。

**理想的多路访问协议**：
- 速率为 R bps 的广播信道
	1. 当一个节点有数据发送时，它能以 R bps 的速率发送（ALOHA、CSMA 满足）
	2. 当有 M 个节点要发送数据，每个节点的平均发送速率为 R/M
	3. 完全分散:
		- 不需要主节点协调传输
		- 不需要时钟、时隙同步
	4. 简单

**多路访问协议类型**：
1. 信道划分协议：时分、频分、码分
	- 把信道划分为小“片” (时隙)
	- 给节点分配专用的小“片”
2. 随机访问协议：ALOHA，CSMA，CSMA/CD（**以太网使用**）
	- 不划分信道，允许冲突
	- 能从冲突中“恢复”
3. 轮流协议：轮询协议、令牌传递协议
	通过轮流访问信道避免冲突，要发送的节点越多轮流时间越长

**信道划分协议**：
TDMA、FDMA、CDMA 三种
设信道支持 N 个节点，传输速率是 R b/s。
- 时分多路访问 TDMA (time division multiple access)：
	将时间划分为时间帧，每个时间帧再划分为 N 个时隙（长度保证发送一个分组），分别分配给 N 个节点。每个节点只在固定分配的时隙中传输。
	- 特点
		1. 避免冲突、公平：每个节点专用速率 R/N b/s。
		2. 节点速率有限：R/N b/s；
		3. 效率不高：节点必须等待它的传输时隙。
- 频分多路访问 FDMA (frequency division multiple access)：
	将总信道带宽 R b/s 划分为 N 个较小信道（频段，带宽为 R/N），分别分配给 N 个节点。
	- 特点：
		1. 避免冲突、公平：N 个节点公平划分带宽；
		2. 节点带宽有限、效率不高：节点带宽为 R/N。
- 码分多路访问 CDMA (Code Division Multiple Access)：
	每个节点分配一个唯一的编码
	每个节点用它唯一的编码来对它发送的数据进行编码
	允许多个节点“共存” ，信号可叠加，即可以同时传输数据而无冲突 (如果编码 是“正交化”的)

**随机访问协议**：
基本思想：
- 发送节点以信道全部速率（R b/s）发送；
- 发生冲突时，冲突的每个节点分别等待一个随机时间，再重发，直到帧 (分组) 发送成功
- 节点间没有协调者
典型随机访问协议：
- ALOHA 协议 (纯 ALOHA，时隙 ALOHA)
- 载波监听多路访问 CSMA 协议
- 带冲突检测的载波监听多路访问 CSMA/CD
- 带冲突避免的载波监听多路访问 CSMA/CA

**ALOHA**：
采用星型拓扑结构，使地理上分散的用户通过无线电来使用中心主机。
- 中心主机通过下行信道向二级主机广播分组；
- 二级主机通过上行信道向中心主机发送分组（可能会冲突，无线电信道是一个公用信道）。
有两种形式：
- 纯 ALOHA
- 时隙 ALOHA

**纯 ALOHA**：
- 非时隙 Aloha: 简单，不需同步
- 帧一到达，立即传输
- 如果与其他帧产生冲突，在该冲突帧传完之后：
	- 以概率 p 立即重传该帧；
	- 或等待一个帧的传输时间，再以概率 p 传输该帧，或者以概率 1-p 等待另一个帧的时间。
- 冲突概率:
	在 t0 发送的帧，和在 [t0-1,t0+1] 的发送的其它帧冲突

**时隙 ALOHA**：
- 假设：
	- 所有帧大小相同
	- 时间被划分为相同大小的时隙，一个时隙等于传送一帧的时间
	- 节点只能在一个时隙的开始才能传送
	- 节点需要同步
	- 如果一个时隙有多个节点同时传送，所有节点都能检测到冲突
- 实现：
	- 当节点要发送新帧，它等到下一时隙开始时传送
	- 没有冲突，节点可以在下一时隙发送新帧
	- 如果有冲突，节点在随后的时隙以概率 p 重传该帧，直到成功为止。
- 优点：
	1. 单个活跃节点可以持续以满速率传送帧
	2. 具有高分散性: 只需节点的时隙同步
	3. 简单
- 缺点：
	1. 冲突，浪费时隙
	2. 空闲时隙
	3. 节点只有在传输数据包时才能检测到冲突

**CSMA（载波监听多路访问）**：
- 载波侦听：某个节点在发送之前，先监听信道。
	- 信道忙：有其他节点正往信道发送帧，该节点随机等待（回退）一段时间，然后再侦听信道。
	- 信道空：该节点开始传输整个数据帧。
- 特点：
	1. 发前监听，可减少冲突。
	2. 由于传播时延的存在，仍有可能出现冲突，并造成信道浪费。

**带冲突检测的 CSMA(CSMA/CD)**：
增加“载波侦听”和“冲突检测”两个规则。
基本原理： 传送前侦听
- 信道忙：延迟传送
- 信道闲：传送整个帧
发送同时进行冲突检测：一旦检测到冲突就立即停止传输， 尽快重发。
目的：缩短无效传送时间，提高信道的利用率。

**以太网 CSMA/CD 的运行机制**：
1. 适配器从网络层得到分组, 创建帧
2. 如果适配器侦听到信道空闲,开始传送帧。如果信道忙, 它会等到信道空闲才传送帧
3. 如果适配器传送整个帧时，都没有检测到其它传输, 则完成该帧的传送
4. 如果适配器在发送中检测到其它传送,就放弃传送，并发送一个拥塞信号
5. 放弃传送后，适配器进入指数回退阶段，即该帧经过 n 次冲突后，适配器在 $\{0,1,2,…,2^m - 1\}$ 中随机选取一个 K 值 ，其中 m=min(n,10),然后等待 K X 512 比特时间后，回到第 2 步（二进制指数回退算法）

**轮流协议**：
1. 轮询协议
	轮询：主节点“邀请”从节点一次传送
	问题：
	- 轮询开销
	- 延时
	- 单点故障（主节点）
2. 令牌传递协议
	控制令牌顺序从一个节点传递到下一个节点
	问题：
	- 令牌开销
	- 延时
	- 单点失效（token）

**局域网：Local Area Network ( LAN** )
- 特点：网络为一个组织所拥有，且地理范围和站点数目均有限
- 局域网按拓扑结构进行分类：星形网、环形网、总线网、树形网和网状网

**网络拓扑结构**：
1. 星型结构：辐射状连接，中央结点集中式通信
	![|265](image/Pasted%20image%2020250613144552.png)
	- 优点：结构简单，访问协议简单，单个节点的故障不会影响到整个网络。
	- 缺点：对中央结点的可靠性要求很高，一有故障，全网瘫痪。
2. 总线结构：所有的站点都连接在同一根传输线，即“总线”上
	![|267](image/Pasted%20image%2020250613144616.png)
	- 优点：结构简单，易于扩充
	- 缺点：故障检测比较困难
3. 环形结构：站与站点之间首尾相接，形成一个环，数据只能沿单方向传输
	![|278](image/Pasted%20image%2020250613144834.png)
	- 优点：这种结构适合于光纤介质。实时性较强
	- 缺点：如果处理不当，站点的故障会引起全网故障
4. 树形结构：从星型拓扑演变而来的，形状像一棵倒挂的树
	![|300](image/Pasted%20image%2020250613144854.png)
	- 特点：与星型拓扑大致相似。它与星型结构相比降低了通信线路成本，增加了网络复杂性
5. 网状结构：网状网络的每一个站点都与其它站点一一直接互连
	![|300](image/Pasted%20image%2020250613144939.png)
	- 优点：连接方法主要是利用冗余的连接，实现站与站之间的高速传输和高容错性能，以提高网络的速度和可靠性
	- 缺点：关系复杂，建网难，维护难

计算机与局域网连接：通过网络接口板进行连接，网络接口板又称通信适配器（Adapter）或网络接口卡 NIC（Network Interface Card），俗称“网卡”。
![|425](image/Pasted%20image%2020250613145222.png)

**链路层寻址和 ARP**：
每个节点有网络层地址和链路层地址。
- 网络层地址：节点在网络中分配的一个唯一地址（IP 地址）。用于把分组送到目的 IP 网络。长度为 32 比特（IPv4）。
- 链路层地址：又叫做 MAC 地址或物理地址、局域网地址。用于把数据帧从一个节点传送到另一个节点 (同一网络中)。
MAC 地址（LAN 地址、物理地址）：
- 节点“网卡”本身所带的地址（唯一）。
- MAC 地址长度通常为 6 字节 (48 比特)，共 248 个。
- 6 字节地址用 16 进制表示，每个字节表示为一对 16 进制数
- 网卡的 MAC 地址是永久的（生产时固化在其 ROM 里）

局域网地址：局域网中每个网卡都有唯一的局域网地址

**MAC 地址分配**：
![|350](image/Pasted%20image%2020250613150227.png)
由专门机构 IEEE 管理物理地址空间：负责分配六个字节中的前三个字节（高 24 位，地址块）
MAC 地址是平面结构：带有同一网卡的节点，在任何网络中都有同样的 MAC 地址。
IP 地址具有层次结构：当节点移动到不同网络时，节点的 IP 地址发生改变。

**MAC 地址识别**：
- 广播信道的局域网中，一个节点发送的帧，在信道上广播传输，其他节点都可能收到该帧。大多数情况，一个节点只向某个特定的节点发送。
- 由“网卡”负责 MAC 地址的封装和识别。
- 发送适配器：将目的 MAC 地址封装到帧中，并发送。所有其他适配器都会收到这个帧。
- 接收适配器：检查帧的目的 MAC 地址是否与自己 MAC 地址相匹配：
	- 匹配：接收该帧，取出数据报，并传递给上层。
	- 不匹配：丢弃该帧。
- 广播帧：发送给所有节点的帧          全 1 地址：FF-FF-FF-FF-FF-FF

节点的 3 种不同地址表示：应用层的主机名，网络层的 IP 地址，链路层的 MAC 地址
实际在链路上传输时，根据 MAC 地址，确定相应的节点
地址之间的转换：主机名 → IP 地址 → MAC 地址
- DNS 域名系统：将主机名解析到 IP 地址。
	DNS 为在因特网中任何地方的主机解析主机名。
- ARP 地址解析协议：将 IP 地址解析到 MAC 地址。
	ARP 只为在**同一个 LAN** 上的节点解析 IP 地址。

**ARP（地址解析协议）**：
ARP 表: 局域网上的每个节点 (主机、路由器) 都有这个表
- 为某些局域网节点进行 IP/MAC 地址映射：< IP address; MAC address; TTL>
- TTL (存活时间): 地址映射将被删除的时间（通常为 20 分钟）

**两个主机位于同一局域网**：
1. 主机 A 希望发送数据报给主机 B，B 的 MAC 地址不在 A 的 ARP 映射表中
2. 主机 A 广播 ARP 查询分组, 其中包含 B 的 IP 地址，目的 MAC 地址 = FF-FF-FF-FF-FF-FF
3. 局域网中所有节点收到 ARP 查询分组
4. 主机 B 收到 ARP 查询分组，返回 B 的 MAC 地址给主机 A，包含有 B 的 MAC 地址的帧发送给主机 A(单播)
5. 主机 A 在它的 ARP 表中缓存 IP-to-MAC 地址对
- 软状态：信息超时会被删除，除非有新的更新消息
- ARP 是即插即用的：节点创建 ARP 表不需要网络管理员的干预

**发送数据报到子网以外**：
 1. 主机 A 构建 IP 数据报，源地址是 A 的 IP 地址，目的地址是 B 的 IP 地址
 2. 主机 A 构建链路层数据帧，目的 MAC 地址是路由器左边端口的 MAC 地址
![|625](image/Pasted%20image%2020250613170003.png)
3. 数据帧从主机 A 发送到路由器 R
4. 路由器 R 收到数据帧，抽取出数据报递交到 IP 层
![|600](image/Pasted%20image%2020250613165935.png)
5. 路由器 R 转发数据报，源地址为 A 的 IP 地址，目的地址为 B 的 IP 地址
6. 路由器 R 将该数据报封装成链路层帧，目的 MAC 地址为主机 B 的 MAC 地址
![|625](image/Pasted%20image%2020250613170155.png)
- 整个传输过程中，数据报的源 IP 地址和目的 IP 地址是不会发生改变的，改变的只是数据帧的源和目的 MAC 地址

**以太网拓扑结构**：
- 总线：所有节点都属于相同的冲突域
- 星形（目前流行）：中心是交换机，每个端口运行一个独立的以太网协议 (节点相互之间不发生碰撞)

![|450](image/Pasted%20image%2020250613171352.png)
1. 以太网的帧结构：
	![|475](image/Pasted%20image%2020250613171504.png)
	- 发送方：发送适配器将 IP 数据报封装成以太网帧，并传递到物理层。
	- 接收方：接收适配器从物理层收到该帧，取出 IP 数据报，并传递给网络层。
2. 前同步码：
	- 前 7 字节是“10101010”，最后一个字节是“10101011”。
	- 使接收方和发送方的时钟同步，接收方一旦收到连续的 8 字节前同步码，可确定有帧传过来。
	- 前同步码是“无效信号”，接收方收到后删除，不向上层传。
	- CRC 的校验范围不包括前同步码。
3. 源、目的 MAC 地址 (各 6 字节)：
	适配器只接收目的地址与其 MAC 地址匹配或广播地址的帧，并将数据字段的内容传递给网络层。否则，丢弃该帧。
4. 类型字段 (2 字节)：
	以太网可以“多路复用”（支持）多种**网络层**协议。通过“类型”字段区分。
	- 发送方填入网络层协议“类型”编号
	- 接收适配器根据“类型”字段，将数据字段传递给相应的网络层协议。
5. 数据字段 (46～1500 字节)：
	携带网络层传来的 IP 数据报
	- 以太网的最大传输单元 MTU 是 1500 字节：若 IP 数据报超过 1500 字节，必须将该数据报分段。
	- 最小长度是 46 字节：如果 IP 数据报小于 46 字节，必须填充为 46 字节。接收方网络层去除填充内容。
6. 循环冗余检测 CRC(4 字节)：
	检测数据帧中是否出现比特差错（翻转）。
	- 发送主机计算 CRC：范围包括目的地址、源地址、类型、数据字段的比特（不包括**前同步码**），结果放入帧 CRC 字段。
	- 接收主机进行 CRC 校验：接收主机对收到的帧进行同样计算，并校验结果是否和 CRC 字段的内容相等。若计算结果不等于 CRC 字段的值 (CRC 校验失败)，该帧有差错。

**以太网提供的服务**：
1. 无连接服务：通信时，发送方适配器不需要先和接收方适配器“握手”。
2. 不可靠的服务：接收到的帧可能包含比特差错。
	- 收到正确帧，不发确认帧；
	- 收到出错帧，丢弃该帧，不发否定帧。
	- 发送适配器不会重发出错帧。
	- 丢弃数据的恢复是通过终端**传输层**的可靠数据传输机制来实现的

**链路层交换机**：
1. 链路层设备
	- 存储转发数据帧
	- 检查达到的数据帧的 MAC 地址，有选择的转发数据帧到一个或多个输出链路，当数据帧被转发到一个共享网段时，使用 CSMA/CD 来访问共享链路
2. 透明
	- 主机不关心是否存在交换机
3. 即插即用和自学习
	- 交换机不需要手工配置
4. 支持多节点同时传输
	- 每个主机由单独的链路直接连到交换机端口
	- 交换机可以缓存数据帧
	- 以太网协议在每个输入链路使用，无碰撞，全双工
	- 每条链路自身是一个碰撞域
	- A-to-A' 和 B-to-B' 可以同时传输，而不会发生碰撞
5. 交换机转发表
	通过自学习得到：(主机的 MAC 地址，到达主机的端口，时戳)
	- 当收到数据帧时，交换机“学习”发送主机的位置：进入的局域网网段 (到达端口)
	- 在转发表中记录发送主机/位置对
6. 数据帧的过滤/转发
	当交换机收到数据帧:
	1. 记录到达链路和发送主机的 MAC 地址
	2. 使用数据帧的目的 MAC 地址，在转发表中检索
	3. 如果在转发表条目中找到对应的 MAC 地址
	4. 执行{
		如果 目的 MAC 地址对应的端口与数据帧的达到端口相同
		则丢弃该数据帧
		否则转发该数据帧到条目指定的端口
		}
	5. 否则，向除到达端口之外的所有端口转发 (**flood**)
7. 交换机互联（组成更大的局域网）
	仍通过泛洪和自学习传递数据
8. 交换机的交换特点
	1. 识别目的 MAC 地址，根据交换表进行端口选择
	2. 识别源 MAC 地址更新交换表
9. 交换机的交换方式
	1. 存储转发（缓存整个帧后再转发）
		具有差错检测功能，转发时延较大，适用于出错率高的链路
		![|450](image/Pasted%20image%2020250613205015.png)
	2. 快速分组又称直通交换（识别出目的地址直接转发）
		不具有差错检测功能，转发时延较小，适用于时延要求高，出错率低的链路
		![|450](image/Pasted%20image%2020250613205134.png)
10. 三次交换机
	一次路由，多次交换
	![|350](image/Pasted%20image%2020250613205624.png)
	- 三层交换是相对于传统的交换概念而提出的
	- 传统的交换技术是在 OSI 网络参考模型中的第二层（即数据链路层）进行操作的，通常称做“二层交换机”。
	- 三层交换技术能够在网络模型中的第三层实现数据包的高速转发。
	- 三层交换技术就是二层交换技术 + 三层转发技术，三层交换机就是“二层交换机 + 基于硬件的路由器”
	工作原理：
	1. 发送站点 A 在开始发送时，把自己的 IP 地址与 B 站的 IP 地址比较，判断 B 站是否与自己在同一子网内。
	2. 若目的站 B 与发送站 A 在同一子网内，则进行二层的转发。
	3. 若两个站点不在同一子网内，则发送站 A 要向“缺省网关”发出 ARP 请求，请求获得 B 的 MAC 地址。
	4. 如果三层交换机知道 B 的 MAC 地址，则向 A 回复 B 的 MAC 地址。否则三层交换机根据路由信息向 B 站广播一个 ARP 请求，B 站得到此 ARP 请求后向三层交换机回复其 MAC 地址，三层交换机将 B 站的 MAC 地址保存到二层交换引擎的 MAC 地址表中，并回复给发送站 A。
	5. A 直接用 B 的 MAC 地址封装数据帧，三层交换机接收到数据后直接进行二层交换。

**交换机与路由器**：
1. 两者都是存储转发设备:
	- 路由器: 网络层设备 (检查网络层头部)
	- 交换机：链路层设备 (检查链路层头部)
2. 两者都有转发表
	- 路由器：使用路由算法计算转发表，基于 IP 地址转发
	- 交换机：通过泛洪、自学习来学习转发表，基于 MAC 地址转发

**VLANs**：
利用支持 VLAN 的交换机，可以在一个实际的物理局域网内，定义多个虚拟的局域网
1. 基于端口的 VLAN
	- 流量隔离：从 1-8 号端口进/出的帧，只能访问 1-8 号端口
	- 动态成员：端口可以在 VLAN 之间动态调整
	- VLAN 间转发：通过路由完成（在实际中，厂商会将路由功能和交换功能都整合在一台设备中）
2. 跨越多个交换机的 VLAN
	- 干线端口（ trunk port ）承载定义在多个物理交换机之上的 VLAN 间的流量
	- 某一个 VLAN 内的流量帧，如果要跨域物理的交换机，需使用 802.1q 格式（带有 VLAN ID 信息）
	- 802.1q 协议的作用：对干线端口之间传输的帧，添加/移除额外的头部字段

**算法**：
 1. 差错检测技术
	 1. 奇偶校验（一维、二维）：最基本的方法
	 2. Internet 校验和：常用于运输层
	 3. 循环冗余检测：常用于链路层